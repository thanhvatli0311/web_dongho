<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh Toán - Shop Đồng Hồ</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .checkout-page-wrapper {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap; /* Cho phép xuống dòng trên màn hình nhỏ */
        }

        .checkout-form-section, .order-summary-section {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .checkout-form-section {
            flex: 2; /* Chiếm 2 phần */
            min-width: 300px; /* Đảm bảo không quá nhỏ */
        }

        .order-summary-section {
            flex: 1; /* Chiếm 1 phần */
            min-width: 280px; /* Đảm bảo không quá nhỏ */
        }

        .checkout-page-wrapper h2 {
            color: #007bff;
            margin-bottom: 25px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group textarea,
        .form-group select {
            width: calc(100% - 22px); /* Trừ padding và border */
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .payment-methods {
            margin-top: 20px;
        }

        .payment-methods label {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .payment-methods input[type="radio"] {
            margin-right: 10px;
            transform: scale(1.2); /* Phóng to radio button */
        }

        .order-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dotted #eee;
        }

        .order-summary-item:last-of-type {
            border-bottom: none;
        }

        .order-summary-total {
            display: flex;
            justify-content: space-between;
            font-size: 1.3em;
            font-weight: bold;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #007bff;
        }

        .order-summary-total span:last-child {
            color: #dc3545;
        }

        .btn-place-order {
            width: 100%;
            background-color: #28a745;
            color: #fff;
            padding: 15px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
            margin-top: 30px;
            transition: background-color 0.3s ease;
        }

        .btn-place-order:hover {
            background-color: #218838;
        }

        .btn-place-order:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .checkout-page-wrapper {
                flex-direction: column;
            }
            .checkout-form-section, .order-summary-section {
                flex: 1 1 100%; /* Chiếm toàn bộ chiều rộng */
                min-width: unset;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <a href="index.html"><h1>Shop Đồng Hồ</h1></a>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">Trang Chủ</a></li>
                    <li><a href="products.html">Sản Phẩm</a></li>
                    <li><a href="cart.html">Giỏ Hàng <span id="cart-count">(0)</span></a></li>
                    <li id="auth-links">
                        <a href="login.html">Đăng Nhập</a>
                        <a href="register.html">Đăng Ký</a>
                    </li>
                    <li id="user-info" style="display: none;">
                        Xin chào, <span id="username-display"></span>! (<a href="#" id="logout-btn">Đăng Xuất</a>)
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="checkout-page-wrapper">
            <div class="checkout-form-section">
                <h2>Thông Tin Giao Hàng</h2>
                <form id="checkout-form">
                    <div class="form-group">
                        <label for="fullname">Họ và tên <span style="color: red;">*</span></label>
                        <input type="text" id="fullname" name="fullname" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email <span style="color: red;">*</span></label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone_number">Số điện thoại <span style="color: red;">*</span></label>
                        <input type="tel" id="phone_number" name="phone_number" required>
                    </div>
                    <div class="form-group">
                        <label for="shipping_address">Địa chỉ giao hàng <span style="color: red;">*</span></label>
                        <textarea id="shipping_address" name="shipping_address" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="notes">Ghi chú (Tùy chọn)</label>
                        <textarea id="notes" name="notes" rows="2"></textarea>
                    </div>

                    <h3 style="margin-top: 30px; color: #007bff; border-bottom: 1px solid #eee; padding-bottom: 10px;">Phương Thức Thanh Toán</h3>
                    <div class="payment-methods">
                        <div class="form-group">
                            <label>
                                <input type="radio" name="payment_method" value="COD" checked>
                                Thanh toán khi nhận hàng (COD)
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="radio" name="payment_method" value="Bank Transfer">
                                Chuyển khoản ngân hàng
                            </label>
                        </div>
                        <!-- Thêm các phương thức khác nếu cần -->
                    </div>
                </form>
            </div>

            <div class="order-summary-section">
                <h2>Tóm Tắt Đơn Hàng</h2>
                <div id="order-summary-items">
                    <!-- Các sản phẩm trong giỏ hàng sẽ được hiển thị ở đây -->
                </div>
                <div class="order-summary-total">
                    <span>Tổng cộng:</span>
                    <span id="order-total-amount">0₫</span>
                </div>
                <button type="submit" form="checkout-form" id="place-order-btn" class="btn-place-order">Đặt Hàng Ngay</button>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2023 Shop Đồng Hồ. All rights reserved.</p>
        </div>
    </footer>

    <script src="js/script.js"></script>
    <script src="js/auth.js"></script>
    <!-- Script riêng cho trang thanh toán -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const checkoutForm = document.getElementById('checkout-form');
            const placeOrderBtn = document.getElementById('place-order-btn');
            const orderSummaryItems = document.getElementById('order-summary-items');
            const orderTotalAmount = document.getElementById('order-total-amount');

            let cartData = {}; // Để lưu trữ dữ liệu giỏ hàng
            let totalAmount = 0;

            // Hàm để tải thông tin người dùng và điền vào form
            const loadUserInfo = async () => {
                const userId = localStorage.getItem('user_id');
                if (!userId) {
                    showToast('Bạn cần đăng nhập để thanh toán.', 'warning');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                    return;
                }

                try {
                    const response = await fetch(`api/users.php?id=${userId}`); // Cần API để lấy thông tin user theo ID
                    const result = await response.json();

                    if (result.success && result.data) {
                        const user = result.data;
                        document.getElementById('fullname').value = user.fullname || '';
                        document.getElementById('email').value = user.email || '';
                        document.getElementById('phone_number').value = user.phone_number || '';
                        document.getElementById('shipping_address').value = user.address || '';
                    } else {
                        showToast('Không thể tải thông tin người dùng.', 'error');
                    }
                } catch (error) {
                    console.error('Error loading user info:', error);
                    showToast('Đã xảy ra lỗi khi tải thông tin người dùng.', 'error');
                }
            };

            // Hàm để tải giỏ hàng và hiển thị tóm tắt đơn hàng
            const loadOrderSummary = async () => {
                orderSummaryItems.innerHTML = '<p>Đang tải giỏ hàng...</p>';
                placeOrderBtn.disabled = true;

                try {
                    const response = await fetch('api/cart.php');
                    const result = await response.json();

                    if (result.success && Object.keys(result.cart).length > 0) {
                        cartData = result.cart; // Lưu dữ liệu giỏ hàng
                        totalAmount = 0;
                        let summaryHtml = '';

                        for (const productId in cartData) {
                            const item = cartData[productId];
                            const itemTotal = item.price * item.quantity;
                            totalAmount += itemTotal;

                            summaryHtml += `
                                <div class="order-summary-item">
                                    <span>${escapeHTML(item.name)} (x${item.quantity})</span>
                                    <span>${formatCurrency(itemTotal)}</span>
                                </div>
                            `;
                        }
                        orderSummaryItems.innerHTML = summaryHtml;
                        orderTotalAmount.textContent = formatCurrency(totalAmount);
                        placeOrderBtn.disabled = false; // Kích hoạt nút đặt hàng
                    } else {
                        orderSummaryItems.innerHTML = '<p>Giỏ hàng của bạn đang trống.</p>';
                        orderTotalAmount.textContent = formatCurrency(0);
                        placeOrderBtn.disabled = true;
                        showToast('Giỏ hàng trống, không thể thanh toán.', 'warning');
                        // Có thể chuyển hướng về trang giỏ hàng hoặc sản phẩm
                        // setTimeout(() => window.location.href = 'cart.html', 3000);
                    }
                } catch (error) {
                    console.error('Error loading cart for checkout:', error);
                    orderSummaryItems.innerHTML = '<p style="color: red;">Đã xảy ra lỗi khi tải giỏ hàng.</p>';
                    placeOrderBtn.disabled = true;
                }
            };

            // Gắn sự kiện gửi form
            checkoutForm.addEventListener('submit', async (e) => {
                e.preventDefault(); // Ngăn chặn gửi form mặc định

                // Kiểm tra giỏ hàng có rỗng không trước khi đặt hàng
                if (Object.keys(cartData).length === 0) {
                    showToast('Giỏ hàng trống, không thể đặt hàng.', 'error');
                    return;
                }

                const formData = new FormData(checkoutForm);
                const orderDetails = {
                    fullname: formData.get('fullname'),
                    email: formData.get('email'),
                    phone_number: formData.get('phone_number'),
                    shipping_address: formData.get('shipping_address'),
                    notes: formData.get('notes'),
                    payment_method: formData.get('payment_method'),
                    total_amount: totalAmount, // Lấy tổng tiền đã tính
                    items: Object.values(cartData).map(item => ({
                        product_id: item.id,
                        quantity: item.quantity,
                        price: item.price
                    }))
                };

                placeOrderBtn.disabled = true; // Vô hiệu hóa nút để tránh gửi nhiều lần
                placeOrderBtn.textContent = 'Đang xử lý...';

                try {
                    const response = await fetch('api/orders.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderDetails)
                    });
                    const result = await response.json();

                    if (result.success) {
                        showToast(result.message, 'success');
                        // Xóa giỏ hàng sau khi đặt hàng thành công
                        // Dùng API DELETE để xóa toàn bộ giỏ hàng
                        await fetch('api/cart.php', { method: 'DELETE' });
                        updateCartCount(); // Cập nhật số lượng giỏ hàng trên header
                        setTimeout(() => {
                            window.location.href = 'profile.html?tab=orders'; // Chuyển hướng đến trang lịch sử đơn hàng
                        }, 2000);
                    } else {
                        showToast(result.message, 'error');
                        placeOrderBtn.disabled = false;
                        placeOrderBtn.textContent = 'Đặt Hàng Ngay';
                    }
                } catch (error) {
                    console.error('Error placing order:', error);
                    showToast('Đã xảy ra lỗi khi đặt hàng. Vui lòng thử lại.', 'error');
                    placeOrderBtn.disabled = false;
                    placeOrderBtn.textContent = 'Đặt Hàng Ngay';
                }
            });

            // Gọi các hàm khởi tạo
            loadUserInfo();
            loadOrderSummary();
        });
    </script>
</body>
</html>