<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ Sơ Của Tôi - Shop Đồng Hồ</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .profile-page-wrapper {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .profile-sidebar {
            flex: 0 0 200px; /* Chiều rộng cố định cho sidebar */
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            height: fit-content; /* Đảm bảo chiều cao không tràn */
        }

        .profile-sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .profile-sidebar li {
            margin-bottom: 10px;
        }

        .profile-sidebar li a {
            display: block;
            padding: 10px 15px;
            color: #333;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .profile-sidebar li a:hover,
        .profile-sidebar li a.active {
            background-color: #007bff;
            color: #fff;
        }

        .profile-content {
            flex: 1;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .profile-content h2 {
            color: #007bff;
            margin-bottom: 25px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        /* Tabs */
        .tab-pane {
            display: none;
        }
        .tab-pane.active {
            display: block;
        }

        /* Form styling (tương tự checkout.html) */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group input[type="password"],
        .form-group textarea {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .form-actions {
            margin-top: 30px;
            text-align: right;
        }

        .form-actions button {
            background-color: #28a745;
            color: #fff;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
        }

        .form-actions button:hover {
            background-color: #218838;
        }

        /* Order history table */
        .order-history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .order-history-table th, .order-history-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            vertical-align: middle;
        }

        .order-history-table th {
            background-color: #f8f8f8;
            font-weight: bold;
        }

        .order-status.pending { color: orange; }
        .order-status.processing { color: #007bff; }
        .order-status.shipped { color: #28a745; }
        .order-status.delivered { color: green; }
        .order-status.cancelled { color: red; }

        .btn-view-order {
            background-color: #007bff;
            color: #fff;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
        }

        /* Order Detail Modal */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* 15% from the top and centered */
            padding: 30px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 800px;
            border-radius: 10px;
            position: relative;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-body p { margin-bottom: 10px; }
        .modal-body ul { list-style: none; padding: 0; margin-top: 15px; }
        .modal-body ul li {
            border-bottom: 1px dotted #eee;
            padding: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-body ul li img { width: 50px; height: 50px; object-fit: cover; margin-right: 10px; border-radius: 4px; }
        .modal-body .item-info { flex-grow: 1; }
        .modal-body .item-price { font-weight: bold; color: #dc3545; }
        .modal-body .modal-total {
            font-size: 1.2em;
            font-weight: bold;
            text-align: right;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        @media (max-width: 768px) {
            .profile-page-wrapper {
                flex-direction: column;
            }
            .profile-sidebar {
                flex: 1 1 100%;
                width: 100%;
            }
            .profile-content {
                flex: 1 1 100%;
            }
            .modal-content {
                width: 95%;
                margin: 20px auto;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <a href="index.html"><h1>Shop Đồng Hồ</h1></a>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">Trang Chủ</a></li>
                    <li><a href="products.html">Sản Phẩm</a></li>
                    <li><a href="cart.html">Giỏ Hàng <span id="cart-count">(0)</span></a></li>
                    <li id="auth-links">
                        <a href="login.html">Đăng Nhập</a>
                        <a href="register.html">Đăng Ký</a>
                    </li>
                    <li id="user-info" style="display: none;">
                        Xin chào, <span id="username-display"></span>! (<a href="#" id="logout-btn">Đăng Xuất</a>)
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="profile-page-wrapper">
            <aside class="profile-sidebar">
                <ul>
                    <li><a href="#personal-info" class="tab-link active" data-tab="personal-info">Thông tin cá nhân</a></li>
                    <li><a href="#order-history" class="tab-link" data-tab="order-history">Lịch sử đơn hàng</a></li>
                    <li><a href="#change-password" class="tab-link" data-tab="change-password">Đổi mật khẩu</a></li>
                </ul>
            </aside>

            <div class="profile-content">
                <!-- Tab: Thông tin cá nhân -->
                <div id="personal-info" class="tab-pane active">
                    <h2>Thông Tin Cá Nhân</h2>
                    <form id="personal-info-form">
                        <div class="form-group">
                            <label for="profile-username">Tên đăng nhập</label>
                            <input type="text" id="profile-username" name="username" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profile-email">Email</label>
                            <input type="email" id="profile-email" name="email">
                        </div>
                        <div class="form-group">
                            <label for="profile-fullname">Họ và tên</label>
                            <input type="text" id="profile-fullname" name="fullname">
                        </div>
                        <div class="form-group">
                            <label for="profile-phone-number">Số điện thoại</label>
                            <input type="tel" id="profile-phone-number" name="phone_number">
                        </div>
                        <div class="form-group">
                            <label for="profile-address">Địa chỉ</label>
                            <textarea id="profile-address" name="address" rows="3"></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit">Cập Nhật Thông Tin</button>
                        </div>
                    </form>
                </div>

                <!-- Tab: Lịch sử đơn hàng -->
                <div id="order-history" class="tab-pane">
                    <h2>Lịch Sử Đơn Hàng</h2>
                    <div id="order-history-list">
                        <p style="text-align: center;">Đang tải lịch sử đơn hàng...</p>
                    </div>
                </div>

                <!-- Tab: Đổi mật khẩu -->
                <div id="change-password" class="tab-pane">
                    <h2>Đổi Mật Khẩu</h2>
                    <form id="change-password-form">
                        <div class="form-group">
                            <label for="old-password">Mật khẩu cũ</label>
                            <input type="password" id="old-password" name="old_password" required>
                        </div>
                        <div class="form-group">
                            <label for="new-password">Mật khẩu mới</label>
                            <input type="password" id="new-password" name="new_password" required>
                        </div>
                        <div class="form-group">
                            <label for="confirm-new-password">Xác nhận mật khẩu mới</label>
                            <input type="password" id="confirm-new-password" name="confirm_new_password" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit">Đổi Mật Khẩu</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal for Order Detail -->
        <div id="orderDetailModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h2>Chi Tiết Đơn Hàng <span id="modal-order-id"></span></h2>
                <div class="modal-body">
                    <p><strong>Ngày đặt:</strong> <span id="modal-order-date"></span></p>
                    <p><strong>Địa chỉ giao hàng:</strong> <span id="modal-shipping-address"></span></p>
                    <p><strong>Số điện thoại:</strong> <span id="modal-phone-number"></span></p>
                    <p><strong>Phương thức thanh toán:</strong> <span id="modal-payment-method"></span></p>
                    <p><strong>Trạng thái:</strong> <span id="modal-order-status"></span></p>
                    <p><strong>Ghi chú:</strong> <span id="modal-order-notes"></span></p>

                    <h3>Sản phẩm</h3>
                    <ul id="modal-order-items">
                        <!-- Order items will be loaded here -->
                    </ul>
                    <div class="modal-total">
                        Tổng cộng: <span id="modal-order-total-amount"></span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2023 Shop Đồng Hồ. All rights reserved.</p>
        </div>
    </footer>

    <script src="js/script.js"></script>
    <script src="js/auth.js"></script>
    <!-- Script riêng cho trang hồ sơ -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const personalInfoForm = document.getElementById('personal-info-form');
            const changePasswordForm = document.getElementById('change-password-form');
            const orderHistoryList = document.getElementById('order-history-list');

            const orderDetailModal = document.getElementById('orderDetailModal');
            const closeButton = document.querySelector('.close-button');

            // --- Quản lý Tabs ---
            const tabLinks = document.querySelectorAll('.tab-link');
            const tabPanes = document.querySelectorAll('.tab-pane');

            function activateTab(tabId) {
                tabPanes.forEach(pane => pane.classList.remove('active'));
                tabLinks.forEach(link => link.classList.remove('active'));

                document.getElementById(tabId).classList.add('active');
                document.querySelector(`.tab-link[data-tab="${tabId}"]`).classList.add('active');

                // Tải dữ liệu riêng cho từng tab khi nó được kích hoạt
                if (tabId === 'personal-info') {
                    loadPersonalInfo();
                } else if (tabId === 'order-history') {
                    loadOrderHistory();
                }
            }

            tabLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = e.target.dataset.tab;
                    // Cập nhật URL để giữ trạng thái tab khi refresh
                    window.history.pushState(null, '', `profile.html?tab=${tabId}`);
                    activateTab(tabId);
                });
            });

            // Kiểm tra URL khi tải trang để kích hoạt tab phù hợp
            const urlParams = new URLSearchParams(window.location.search);
            const initialTab = urlParams.get('tab') || 'personal-info';
            activateTab(initialTab);


            // --- Load thông tin cá nhân ---
            const loadPersonalInfo = async () => {
                const userId = localStorage.getItem('user_id');
                if (!userId) {
                    showToast('Bạn cần đăng nhập để xem hồ sơ.', 'warning');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                    return;
                }
                try {
                    const response = await fetch(`api/users.php?id=${userId}`);
                    const result = await response.json();

                    if (result.success && result.data) {
                        const user = result.data;
                        document.getElementById('profile-username').value = user.username || '';
                        document.getElementById('profile-email').value = user.email || '';
                        document.getElementById('profile-fullname').value = user.fullname || '';
                        document.getElementById('profile-phone-number').value = user.phone_number || '';
                        document.getElementById('profile-address').value = user.address || '';
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (error) {
                    console.error('Error loading personal info:', error);
                    showToast('Đã xảy ra lỗi khi tải thông tin cá nhân.', 'error');
                }
            };

            // --- Cập nhật thông tin cá nhân ---
            personalInfoForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userId = localStorage.getItem('user_id');
                if (!userId) { return; }

                const formData = new FormData(personalInfoForm);
                const updatedInfo = {
                    email: formData.get('email'),
                    fullname: formData.get('fullname'),
                    phone_number: formData.get('phone_number'),
                    address: formData.get('address')
                };

                try {
                    const response = await fetch(`api/users.php?id=${userId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updatedInfo)
                    });
                    const result = await response.json();
                    showToast(result.message, result.success ? 'success' : 'error');
                    if (result.success) {
                        // Cập nhật lại username trên header nếu fullname thay đổi
                        updateAuthDisplay();
                    }
                } catch (error) {
                    console.error('Error updating personal info:', error);
                    showToast('Đã xảy ra lỗi khi cập nhật thông tin.', 'error');
                }
            });

            // --- Đổi mật khẩu ---
            changePasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userId = localStorage.getItem('user_id');
                if (!userId) { return; }

                const oldPassword = document.getElementById('old-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmNewPassword = document.getElementById('confirm-new-password').value;

                if (newPassword !== confirmNewPassword) {
                    showToast('Mật khẩu mới và xác nhận mật khẩu không khớp.', 'error');
                    return;
                }
                if (newPassword.length < 6) {
                    showToast('Mật khẩu mới phải có ít nhất 6 ký tự.', 'error');
                    return;
                }

                try {
                    const response = await fetch(`api/users.php?id=${userId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ old_password: oldPassword, new_password: newPassword })
                    });
                    const result = await response.json();
                    showToast(result.message, result.success ? 'success' : 'error');
                    if (result.success) {
                        changePasswordForm.reset(); // Xóa form sau khi đổi thành công
                    }
                } catch (error) {
                    console.error('Error changing password:', error);
                    showToast('Đã xảy ra lỗi khi đổi mật khẩu.', 'error');
                }
            });

            // --- Tải lịch sử đơn hàng ---
            const loadOrderHistory = async () => {
                orderHistoryList.innerHTML = '<p style="text-align: center;">Đang tải lịch sử đơn hàng...</p>';
                const userId = localStorage.getItem('user_id');
                if (!userId) { return; }

                try {
                    const response = await fetch('api/orders.php'); // Lấy tất cả đơn hàng của user_id
                    const result = await response.json();

                    if (result.success && result.data.length > 0) {
                        let orderHtml = `
                            <table class="order-history-table">
                                <thead>
                                    <tr>
                                        <th>Mã ĐH</th>
                                        <th>Ngày đặt</th>
                                        <th>Tổng tiền</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        result.data.forEach(order => {
                            orderHtml += `
                                <tr>
                                    <td>#${order.id}</td>
                                    <td>${new Date(order.order_date).toLocaleDateString('vi-VN')}</td>
                                    <td>${formatCurrency(order.total_amount)}</td>
                                    <td><span class="order-status ${order.status}">${formatOrderStatus(order.status)}</span></td>
                                    <td><button class="btn-view-order" data-order-id="${order.id}">Xem chi tiết</button></td>
                                </tr>
                            `;
                        });
                        orderHtml += `
                                </tbody>
                            </table>
                        `;
                        orderHistoryList.innerHTML = orderHtml;

                        // Gắn sự kiện cho nút "Xem chi tiết"
                        document.querySelectorAll('.btn-view-order').forEach(button => {
                            button.addEventListener('click', (e) => {
                                const orderId = e.target.dataset.orderId;
                                showOrderDetail(orderId);
                            });
                        });
                    } else {
                        orderHistoryList.innerHTML = '<p style="text-align: center;">Bạn chưa có đơn hàng nào.</p>';
                    }
                } catch (error) {
                    console.error('Error loading order history:', error);
                    orderHistoryList.innerHTML = '<p style="text-align: center; color: red;">Đã xảy ra lỗi khi tải lịch sử đơn hàng.</p>';
                }
            };

            // --- Hiển thị chi tiết đơn hàng trong Modal ---
            const showOrderDetail = async (orderId) => {
                try {
                    const response = await fetch(`api/orders.php?id=${orderId}`);
                    const result = await response.json();

                    if (result.success && result.data) {
                        const order = result.data;
                        document.getElementById('modal-order-id').textContent = `#${order.id}`;
                        document.getElementById('modal-order-date').textContent = new Date(order.order_date).toLocaleString('vi-VN');
                        document.getElementById('modal-shipping-address').textContent = escapeHTML(order.shipping_address);
                        document.getElementById('modal-phone-number').textContent = escapeHTML(order.phone_number);
                        document.getElementById('modal-payment-method').textContent = formatPaymentMethod(order.payment_method);
                        document.getElementById('modal-order-status').textContent = formatOrderStatus(order.status);
                        document.getElementById('modal-order-status').className = `order-status ${order.status}`; // Cập nhật class
                        document.getElementById('modal-order-notes').textContent = escapeHTML(order.notes || 'Không có');
                        document.getElementById('modal-order-total-amount').textContent = formatCurrency(order.total_amount);

                        const orderItemsList = document.getElementById('modal-order-items');
                        orderItemsList.innerHTML = ''; // Clear previous items

                        order.items.forEach(item => {
                            const listItem = document.createElement('li');
                            listItem.innerHTML = `
                                <img src="${item.image_url ? 'images/products/' + item.image_url : 'images/placeholder.jpg'}" alt="${escapeHTML(item.product_name)}">
                                <div class="item-info">
                                    ${escapeHTML(item.product_name)} (x${item.quantity})
                                </div>
                                <span class="item-price">${formatCurrency(item.price * item.quantity)}</span>
                            `;
                            orderItemsList.appendChild(listItem);
                        });

                        orderDetailModal.style.display = 'block'; // Hiển thị modal
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (error) {
                    console.error('Error fetching order detail:', error);
                    showToast('Đã xảy ra lỗi khi tải chi tiết đơn hàng.', 'error');
                }
            };

            // --- Đóng Modal ---
            closeButton.addEventListener('click', () => {
                orderDetailModal.style.display = 'none';
            });
            window.addEventListener('click', (event) => {
                if (event.target === orderDetailModal) {
                    orderDetailModal.style.display = 'none';
                }
            });

            // Helper function to format order status
            function formatOrderStatus(status) {
                const statusMap = {
                    'pending': 'Chờ xác nhận',
                    'processing': 'Đang xử lý',
                    'shipped': 'Đang giao hàng',
                    'delivered': 'Đã giao hàng',
                    'cancelled': 'Đã hủy'
                };
                return statusMap[status] || status;
            }

            function formatPaymentMethod(method) {
                const methodMap = {
                    'COD': 'Thanh toán khi nhận hàng',
                    'Bank Transfer': 'Chuyển khoản ngân hàng',
                    'MoMo': 'Ví điện tử MoMo', // ví dụ
                    'ZaloPay': 'Ví điện tử ZaloPay', // ví dụ
                    'Credit Card': 'Thẻ tín dụng' // ví dụ
                };
                return methodMap[method] || method;
            }
        });
    </script>
</body>
</html>